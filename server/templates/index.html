<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Monitor RasPi - Segurança FNAF</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    @font-face {
      font-family: 'Basic5';
      src: url("{{ url_for('static', filename='Basic5.ttf') }}") format('truetype');
    }
  </style>
</head>
<body>
  <h1>Fazbear Entertainment Security</h1>

  <div class="nav">
    <a href="{{ url_for('logs') }}" class="btn">Visualizar Logs do Servidor</a>
  </div>

  <!-- container sempre presente -->
  <div class="monitor-grid"></div>

  <script>
    const grid = document.querySelector('.monitor-grid');
    const initial = {{ records|tojson }};
    let renderedCount = initial.length;

    function renderFrame(r) {
      const f = document.createElement('div');
      f.className = 'frame';
      f.innerHTML = `
        <img src="data:image/jpeg;base64,${r.image_b64}" alt="Cam ${r.camera}">
        <div class="info">
          <div>Data: ${r.date}</div>
          <div>Hora: ${r.time}</div>
          <div>Dist: ${r.distance} cm</div>
          <div>Cam: ${r.camera}</div>
        </div>
      `;
      return f;
    }

    // se não há registros, mostra mensagem
    if (initial.length === 0) {
      const msg = document.createElement('p');
      msg.textContent = 'Nenhum registro enviado ainda.';
      msg.style.color = '#a020f0';
      grid.appendChild(msg);
    } else {
      // renderiza os já existentes
      initial.slice().reverse().forEach(r => grid.appendChild(renderFrame(r)));
    }

    async function fetchNew() {
      const resp = await fetch('{{ url_for("api_records") }}');
      const all  = await resp.json();
      if (all.length > renderedCount) {
        // limpa a mensagem inicial, se existir
        if (renderedCount === 0) grid.innerHTML = '';
        const novos = all.slice(renderedCount);
        novos.reverse().forEach(r => {
          grid.insertBefore(renderFrame(r), grid.firstChild);
          renderedCount++;
        });
        while (grid.children.length > 12) {
          grid.removeChild(grid.lastChild);
        }
      }
    }

    setInterval(fetchNew, 1000);
  </script>
</body>
</html>
